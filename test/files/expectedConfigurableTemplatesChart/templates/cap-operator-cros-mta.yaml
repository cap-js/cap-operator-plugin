---
apiVersion: sme.sap.com/v1alpha1
kind: CAPApplication
metadata:
  name: cap-{{ include "appName" $ }}
spec:
  domains:
    primary: {{.Values.app.domains.primary}}
    {{- if .Values.app.domains.secondary }}
    secondary:
      {{- range .Values.app.domains.secondary }}
      - {{.}}
      {{- end }}
    {{- end }}
    istioIngressGatewayLabels:
    {{- range $k, $v := .Values.app.istioIngressGatewayLabels }}
    - name: {{ $k }}
      value: {{ $v | default "invalidValue"}}
    {{- end }}
  btpAppName: {{ include "appName" $ }}
  globalAccountId: {{.Values.btp.globalAccountId}}
  provider:
    subDomain: {{.Values.btp.provider.subdomain}}
    tenantId: {{.Values.btp.provider.tenantId}}
  btp:
    services:
    {{- $serviceInstances := .Values.serviceInstances }}
    {{- range $k, $v := .Values.serviceBindings }}
    {{- $serviceInstance := dict }}
    {{- range $sik, $siv := $serviceInstances }}
      {{- if eq $siv.name $v.serviceInstanceName }}
        {{- $serviceInstance = $siv }}
      {{- end }}
    {{- end }}
    {{- if hasKey $serviceInstance "serviceOfferingName" }}
    - class: {{ get $serviceInstance "serviceOfferingName" | default "invalidValue" }}
      {{- if $v.externalName }}
      name: {{ $v.externalName | default "invalidValue" }}
      {{- else }}
      name: {{ $v.name | default "invalidValue" }}
      {{- end }}
      secret: {{ $v.secretName | default "invalidValue" }}
    {{- end }}
    {{- end }}
---
apiVersion: sme.sap.com/v1alpha1
kind: CAPApplicationVersion
metadata:
  annotations:
    helm.sh/hook: post-install,post-upgrade
    helm.sh/resource-policy: keep
  name: {{ include "capApplicationVersionName" $ }}
spec:
  capApplicationInstance: cap-{{ include "appName" $ }}
  version: "{{ .Release.Revision }}"
  registrySecrets:
    {{- range .Values.imagePullSecrets }}
    - {{.}}
    {{- end }}
  workloads:
  - name: author-readings-approuter
    consumedBTPServices:
      - author-readings-uaa-bind
      - author-readings-destination-service-bind
      - author-readings-auditlog-bind
      - author-readings-registry-bind
      - author-readings-html5-runtime-bind
    deploymentDefinition:
      type: Router
      image: "{{.Values.workloads.author-readings-approuter.image}}"
      env:
        - name: TENANT_HOST_PATTERN
          value: ^(.*).${org}-${space}.${domain}
        - name: httpHeaders
          value: "[{ \"Content-Security-Policy\": \"frame-ancestors 'self'
            https://*.hana.ondemand.com\" }]"
        - name: CORS
          value: '[{"uriPattern":".*","allowedOrigin":[{"host":"*.${org}-${space}.${domain}","protocol":"https"}]}]'
  - name: author-readings-srv
    consumedBTPServices:
      - author-readings-service-manager-bind
      - author-readings-uaa-bind
      - author-readings-destination-service-bind
      - author-readings-auditlog-bind
      - author-readings-registry-bind
    deploymentDefinition:
      type: null
      image: "{{.Values.workloads.author-readings-srv.image}}"
      env:
        - name: OTLP_TRACE_URL
          value: http://telemetry-otlp-traces.kyma-system:4318
        - name: IS_MTXS_ENABLED
          value: "true"
        - name: SUBSCRIPTION_URL
          value: ${protocol}://\${tenant_subdomain}.${app-url}-srv.${domain}
  - name: author-readings-mtx-srv
    consumedBTPServices:
      - author-readings-auditlog-bind
      - author-readings-uaa-bind
      - author-readings-destination-service-bind
      - author-readings-service-manager-author-readings-mtx-srv-bind
      - author-readings-logging-bind
    deploymentDefinition:
      type: null
      image: "{{.Values.workloads.author-readings-mtx-srv.image}}"
      env: []
  - name: author-readings-app-deployer
    consumedBTPServices:
      - author-readings-html5-repo-host-bind
      - author-readings-uaa-bind
    jobDefinition:
      type: Content
      image: "{{.Values.workloads.author-readings-app-deployer.image}}"
      env: []
  - name: author-readings-mtx
    consumedBTPServices:
      - author-readings-registry-bind
      - author-readings-logging-bind
      - author-readings-service-manager-bind
      - author-readings-uaa-bind
    jobDefinition:
      type: TenantOperation
      image: "{{.Values.workloads.author-readings-mtx.image}}"
      env: []
  - name: author-readings
    consumedBTPServices:
      - author-readings-uaa-bind
      - author-readings-logging-bind
    deploymentDefinition:
      type: null
      image: "{{.Values.workloads.author-readings.image}}"
      env:
        - name: TENANT_HOST_PATTERN
          value: ^(.*)-${default-uri}
